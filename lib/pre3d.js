var Pre3d=function(){function t(t,i){return t.x*i.x+t.y*i.y+t.z*i.z}function i(t,i){return{x:t.x-i.x,y:t.y-i.y}}function e(t,i){return{x:t.x+i.x,y:t.y+i.y,z:t.z+i.z}}function r(t,i){return{x:t.x*i,y:t.y*i}}function n(t,i){return{x:t.x*i,y:t.y*i,z:t.z*i}}function o(t){var i=t.x;return t=t.y,Math.sqrt(i*i+t*t)}function s(t){var i=t.x,e=t.y;return t=t.z,Math.sqrt(i*i+e*e+t*t)}function a(t){return r(t,1/o(t))}function h(t){return n(t,1/s(t))}function u(t,i,e,r,n,o,s,a,h,u,c,f){this.e0=t,this.e1=i,this.e2=e,this.e3=r,this.e4=n,this.e5=o,this.e6=s,this.e7=a,this.e8=h,this.e9=u,this.e10=c,this.e11=f}function c(t,i){var e=t.e0,r=t.e1,n=t.e2,o=t.e4,s=t.e5,a=t.e6,h=t.e8,c=t.e9,f=t.e10,l=i.e0,p=i.e1,y=i.e2,m=i.e3,x=i.e4,d=i.e5,v=i.e6,g=i.e7,_=i.e8,b=i.e9,P=i.e10,z=i.e11;return new u(e*l+r*x+n*_,e*p+r*d+n*b,e*y+r*v+n*P,e*m+r*g+n*z+t.e3,o*l+s*x+a*_,o*p+s*d+a*b,o*y+s*v+a*P,o*m+s*g+a*z+t.e7,h*l+c*x+f*_,h*p+c*d+f*b,h*y+c*v+f*P,h*m+c*g+f*z+t.e11)}function f(t){var i=Math.sin(t);return t=Math.cos(t),new u(1,0,0,0,0,t,-i,0,0,i,t,0)}function l(t){var i=Math.sin(t);return t=Math.cos(t),new u(t,0,i,0,0,1,0,0,-i,0,t,0)}function p(t){var i=Math.sin(t);return t=Math.cos(t),new u(t,-i,0,0,i,t,0,0,0,0,1,0)}function y(t,i){return{x:t.e0*i.x+t.e1*i.y+t.e2*i.z+t.e3,y:t.e4*i.x+t.e5*i.y+t.e6*i.z+t.e7,z:t.e8*i.x+t.e9*i.y+t.e10*i.z+t.e11}}function m(){this.reset()}function x(t,i){for(var e=i.length,r=Array(e),n=0;e>n;++n)r[n]=y(t,i[n]);return r}function d(t,e){var r=a(i(e,t));e.x+=r.x,e.y+=r.y,t.x-=r.x,t.y-=r.y}function v(t,i,e,r){this.setRGBA(t,i,e,r)}function g(t,i,e,r){this.i0=t,this.i1=i,this.i2=e,this.i3=r,this.normal2=this.normal1=this.centroid=null}function _(t,i,e){this.ep=t,this.c0=i,this.c1=e}function b(){this.transform=new m,this.focal_length=1}function P(t){this.draw_overdraw=this.perform_z_sorting=!0,this.draw_backfaces=!1,this.texture=null,this.fill_rgba=new v(1,0,0,1),this.normal2_rgba=this.normal1_rgba=this.stroke_rgba=null,this.canvas=t,this.ctx=t.getContext("2d"),this.camera=new b,this.transform=new m,this.transform_stack_=[],this.quad_callback=null,this.width_=t.width,this.height_=t.height,this.scale_=this.height_/2,this.xoff_=this.width_/2,this.buffered_quads_=null,this.emptyBuffer(),null==this.ctx.setStrokeColor&&(this.ctx.setStrokeColor=function(t,i,e,r){this.strokeStyle="rgba("+[Math.floor(255*t),Math.floor(255*i),Math.floor(255*e),r].join(",")+")"}),null==this.ctx.setFillColor&&(this.ctx.setFillColor=function(t,i,e,r){this.fillStyle="rgba("+[Math.floor(255*t),Math.floor(255*i),Math.floor(255*e),r].join(",")+")"})}function z(t,i,e,r,n,o,s,a,h,u,c,f,l,p){t.save(),t.beginPath(),t.moveTo(e,r),t.lineTo(n,o),t.lineTo(s,a),t.closePath(),t.clip();var y=h*(p-f)-c*p+l*f+(c-l)*u;t.transform(-(u*(s-n)-f*s+p*n+(f-p)*e)/y,(f*a+u*(o-a)-p*o+(p-f)*r)/y,(h*(s-n)-c*s+l*n+(c-l)*e)/y,-(c*a+h*(o-a)-l*o+(l-c)*r)/y,(h*(p*n-f*s)+u*(c*s-l*n)+(l*f-c*p)*e)/y,(h*(p*o-f*a)+u*(c*a-l*o)+(l*f-c*p)*r)/y),t.drawImage(i,0,0),t.restore()}function T(t,i){return t.qf.centroid.z-i.qf.centroid.z}m.prototype.reset=function(){this.m=new u(1,0,0,0,0,1,0,0,0,0,1,0)},m.prototype.rotateX=function(t){this.m=c(f(t),this.m)},m.prototype.rotateXPre=function(t){this.m=c(this.m,f(t))},m.prototype.rotateY=function(t){this.m=c(l(t),this.m)},m.prototype.rotateYPre=function(t){this.m=c(this.m,l(t))},m.prototype.rotateZ=function(t){this.m=c(p(t),this.m)},m.prototype.rotateZPre=function(t){this.m=c(this.m,p(t))},m.prototype.translate=function(t,i,e){this.m=c(new u(1,0,0,t,0,1,0,i,0,0,1,e),this.m)},m.prototype.translatePre=function(t,i,e){this.m=c(this.m,new u(1,0,0,t,0,1,0,i,0,0,1,e))},m.prototype.scale=function(t,i,e){this.m=c(new u(t,0,0,0,0,i,0,0,0,0,e,0),this.m)},m.prototype.scalePre=function(t,i,e){this.m=c(this.m,new u(t,0,0,0,0,i,0,0,0,0,e,0))},m.prototype.transformPoint=function(t){return y(this.m,t)},m.prototype.multTransform=function(t){this.m=c(this.m,t.m)},m.prototype.setDCM=function(t,i,e){var r=this.m;r.e0=t.x,r.e4=t.y,r.e8=t.z,r.e1=i.x,r.e5=i.y,r.e9=i.z,r.e2=e.x,r.e6=e.y,r.e10=e.z},m.prototype.dup=function(){var t=new m;return t.m=new u(this.m.e0,this.m.e1,this.m.e2,this.m.e3,this.m.e4,this.m.e5,this.m.e6,this.m.e7,this.m.e8,this.m.e9,this.m.e10,this.m.e11),t},v.prototype.setRGBA=function(t,i,e,r){this.r=t,this.g=i,this.b=e,this.a=r},v.prototype.setRGB=function(t,i,e){this.setRGBA(t,i,e,1)},v.prototype.invert=function(){this.r=1-this.r,this.g=1-this.g,this.b=1-this.b},v.prototype.dup=function(){return new v(this.r,this.g,this.b,this.a)},g.prototype.isTriangle=function(){return null===this.i3},g.prototype.setQuad=function(t,i,e,r){this.i0=t,this.i1=i,this.i2=e,this.i3=r},g.prototype.setTriangle=function(t,i,e){this.i0=t,this.i1=i,this.i2=e,this.i3=null},_.prototype.isQuadratic=function(){return null===this.c1},_.prototype.setQuadratic=function(t,i){this.ep=t,this.c0=i,this.c1=null},_.prototype.setCubic=function(t,i,e){this.ep=t,this.c0=i,this.c1=e},P.prototype.pushTransform=function(){this.transform_stack_.push(this.transform.dup())},P.prototype.popTransform=function(){this.transform=this.transform_stack_.pop()},P.prototype.emptyBuffer=function(){this.buffered_quads_=[]},P.prototype.projectPointToCanvas=function(t){var i=this.camera.focal_length/-t.z,e=this.scale_;return{x:t.x*i*e+this.xoff_,y:t.y*i*-e+e}},P.prototype.projectPointsToCanvas=function(t){for(var i=t.length,e=Array(i),r=0;i>r;++r)e[r]=this.projectPointToCanvas(t[r]);return e},P.prototype.projectQuadFaceToCanvasIP=function(t){return t.i0=this.projectPointToCanvas(t.i0),t.i1=this.projectPointToCanvas(t.i1),t.i2=this.projectPointToCanvas(t.i2),t.isTriangle()||(t.i3=this.projectPointToCanvas(t.i3)),t};var w={x:0,y:0,z:1};return P.prototype.bufferShape=function(i){var e,r=this.draw_backfaces,n=this.quad_callback,o=c(this.camera.transform.m,this.transform.m);e=o.e0;var s=o.e1,a=o.e2,f=o.e4,l=o.e5,p=o.e6,m=o.e8,d=o.e9,v=o.e10;for(e=new u(v*l-p*d,p*m-f*v,f*d-m*l,0,a*d-v*s,v*e-a*m,m*s-e*d,0,p*s-a*l,f*a-p*e,e*l-f*s,0),s=x(o,i.vertices),a=i.quads,f=0,l=i.quads.length;l>f;++f){var _=a[f];(null===n||n(_,f,i)!==!0)&&(p=y(o,_.centroid),p.z>=-1||(m=h(y(e,_.normal1)),d=y(e,_.normal2),r!==!0&&t(p,m)>0&&t(p,d)>0||(v=t(w,m),0>v&&(v=0),_=_.isTriangle()===!0?new g(s[_.i0],s[_.i1],s[_.i2],null):new g(s[_.i0],s[_.i1],s[_.i2],s[_.i3]),_.centroid=p,_.normal1=m,_.normal2=d,this.buffered_quads_.push({qf:_,intensity:v,draw_overdraw:this.draw_overdraw,texture:this.texture,fill_rgba:this.fill_rgba,stroke_rgba:this.stroke_rgba,normal1_rgba:this.normal1_rgba,normal2_rgba:this.normal2_rgba}))))}},P.prototype.drawBackground=function(){this.ctx.fillRect(0,0,this.width_,this.height_)},P.prototype.clearBackground=function(){this.ctx.clearRect(0,0,this.width_,this.height_)},P.prototype.drawBuffer=function(){var t=this.ctx,i=this.buffered_quads_,r=i.length;this.perform_z_sorting===!0&&i.sort(T);for(var n=0;r>n;++n){var o=i[n],s=o.qf;this.projectQuadFaceToCanvasIP(s);var a=s.isTriangle();o.draw_overdraw===!0&&(d(s.i0,s.i1),d(s.i1,s.i2),a===!0?d(s.i2,s.i0):(d(s.i2,s.i3),d(s.i3,s.i0))),t.beginPath(),t.moveTo(s.i0.x,s.i0.y),t.lineTo(s.i1.x,s.i1.y),t.lineTo(s.i2.x,s.i2.y),a!==!0&&t.lineTo(s.i3.x,s.i3.y);var u=o.fill_rgba;if(null!==u){var c=o.intensity;t.setFillColor(u.r*c,u.g*c,u.b*c,u.a),t.fill()}u=o.texture,null!==u&&(z(t,u.image,s.i0.x,s.i0.y,s.i1.x,s.i1.y,s.i2.x,s.i2.y,u.u0,u.v0,u.u1,u.v1,u.u2,u.v2),a||z(t,u.image,s.i0.x,s.i0.y,s.i2.x,s.i2.y,s.i3.x,s.i3.y,u.u0,u.v0,u.u2,u.v2,u.u3,u.v3)),a=o.stroke_rgba,null!==a&&(t.closePath(),t.setStrokeColor(a.r,a.g,a.b,a.a),t.stroke()),a=o.normal1_rgba,o=o.normal2_rgba,null!==a&&(t.setStrokeColor(a.r,a.g,a.b,a.a),a=this.projectPointToCanvas(s.centroid),u=this.projectPointToCanvas(e(s.centroid,h(s.normal1))),t.beginPath(),t.moveTo(a.x,a.y),t.lineTo(u.x,u.y),t.stroke()),null!==o&&(t.setStrokeColor(o.r,o.g,o.b,o.a),a=this.projectPointToCanvas(s.centroid),u=this.projectPointToCanvas(e(s.centroid,h(s.normal2))),t.beginPath(),t.moveTo(a.x,a.y),t.lineTo(u.x,u.y),t.stroke())}return r},P.prototype.drawPath=function(t,i){var e=this.ctx;i=i||{};var r=c(this.camera.transform.m,this.transform.m),n=this.projectPointsToCanvas(x(r,t.points));r=null===t.starting_point?this.projectPointToCanvas(y(r,{x:0,y:0,z:0})):n[t.starting_point],e.beginPath(),e.moveTo(r.x,r.y),r=t.curves;for(var o=0,s=r.length;s>o;++o){var a=r[o];if(a.isQuadratic()===!0){var h=n[a.c0];a=n[a.ep],e.quadraticCurveTo(h.x,h.y,a.x,a.y)}else{h=n[a.c0];var u=n[a.c1];a=n[a.ep],e.bezierCurveTo(h.x,h.y,u.x,u.y,a.x,a.y)}}i.fill===!0?e.fill():e.stroke()},{RGBA:v,AffineMatrix:u,Transform:m,QuadFace:g,Shape:function(){this.vertices=[],this.quads=[]},Curve:_,Path:function(){this.points=[],this.curves=[],this.starting_point=null},Camera:b,TextureInfo:function(){this.v3=this.u3=this.v2=this.u2=this.v1=this.u1=this.v0=this.u0=this.image=null},Renderer:P,Math:{crossProduct:function(t,i){return{x:t.y*i.z-t.z*i.y,y:t.z*i.x-t.x*i.z,z:t.x*i.y-t.y*i.x}},dotProduct2d:function(t,i){return t.x*i.x+t.y*i.y},dotProduct3d:t,subPoints2d:i,subPoints3d:function(t,i){return{x:t.x-i.x,y:t.y-i.y,z:t.z-i.z}},addPoints2d:function(t,i){return{x:t.x+i.x,y:t.y+i.y}},addPoints3d:e,mulPoint2d:r,mulPoint3d:n,vecMag2d:o,vecMag3d:s,unitVector2d:a,unitVector3d:h,linearInterpolate:function(t,i,e){return(i-t)*e+t},linearInterpolatePoints3d:function(t,i,e){return{x:(i.x-t.x)*e+t.x,y:(i.y-t.y)*e+t.y,z:(i.z-t.z)*e+t.z}},averagePoints:function(t){for(var i={x:0,y:0,z:0},e=0,r=t.length;r>e;++e){var n=t[e];i.x+=n.x,i.y+=n.y,i.z+=n.z}return t=1/r,i.x*=t,i.y*=t,i.z*=t,i}}}}();
